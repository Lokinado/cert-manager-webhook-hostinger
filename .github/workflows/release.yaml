name: Publish New Version (Image + Chart)

on:
  release:
    types: [created]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  contents: read
  packages: write

jobs:
  build-push-image:
    name: Build and publish Docker image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Check out repository code (from tag commit)
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU (for platform emulation)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract Docker metadata (tags and labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # Use semver tag, e.g., 'v1.0.1' (from release)
            type=semver,pattern={{version}}
            # Use semver tag, e.g., 'v1.0' (from release 'v1.0.1')
            type=semver,pattern={{major}}.{{minor}}
            # Tag as 'latest' only if it's the newest semver release
            type=semver,pattern=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          build-args: CGO_ENABLED=0
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  publish-helm-chart:
    name: Publish Helm Chart
    runs-on: ubuntu-latest
    needs: build-push-image

    permissions:
      contents: read
      packages: write

    steps:
      - name: Check out repository code (from tag commit)
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest' # Use the latest Helm version

      - name: Log in to GHCR (for Helm OCI)
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ${{ env.REGISTRY }} \
            --username ${{ github.repository_owner }} \
            --password-stdin

      - name: Extract version from tag
        id: get_version
        run: |
          TAG_NAME="${{ github.ref_name }}"
          VERSION_NAME="${TAG_NAME#v}"
          
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_OUTPUT

      - name: Update chart versions
        env:
          TAG: ${{ steps.get_version.outputs.TAG_NAME }}
          VERSION: ${{ steps.get_version.outputs.VERSION_NAME }}
          CHART_PATH: ./deploy/cert-manager-webhook-hostinger
        run: |
          echo "Updating chart at $CHART_PATH to version $VERSION (appVersion: $TAG, image.tag: $TAG)"
             
          # 1. Update Chart.yaml -> 'version'
          yq -i ".version = \"$VERSION\"" "${CHART_PATH}/Chart.yaml"
          
          # 2. Update Chart.yaml -> 'appVersion'
          yq -i ".appVersion = \"$TAG\"" "${CHART_PATH}/Chart.yaml"
          
          # 3. Update values.yaml -> 'image.tag'
          yq -i ".image.tag = \"$TAG\"" "${CHART_PATH}/values.yaml"
          
          echo "--- New Chart.yaml ---"
          cat "${CHART_PATH}/Chart.yaml"
          echo "--- New values.yaml ---"
          cat "${CHART_PATH}/values.yaml"

      - name: Package Helm Chart
        id: package_chart
        env:
          CHART_PATH: ./deploy/cert-manager-webhook-hostinger
        run: |
          CHART_FILE_PATH=$(helm package $CHART_PATH | awk -F "Successfully packaged chart and saved it to: " '{print $2}')
          echo "Packaged chart: $CHART_FILE_PATH"
          echo "CHART_FILE_PATH=$CHART_FILE_PATH" >> $GITHUB_OUTPUT

      - name: Publish Helm Chart to GHCR (OCI)
        env:
          CHART_FILE: ${{ steps.package_chart.outputs.CHART_FILE_PATH }}
          OCI_NAMESPACE: ${{ github.repository_owner }}
        run: |
          echo "Publishing chart $CHART_FILE to oci://${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          helm push $CHART_FILE oci://${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}